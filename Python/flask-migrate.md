---
id: flask-migrate
aliases: []
tags: []
---
**Back**
    [[Flask]]

# Flask-Migrate
---
Flask-обертка для Alembic, основа для миграции базы данных SQLAlchemy

## Инициализация
---
```python
from flask import Flask
from flask-sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

app = Flask(__name__)
app.config.from_object(Config)
db = SQLAlchemy(app)
migrate = Migrate(app, db)
```

Создание репозитория миграции
```bash
# Определение переменных
SQLALCHEMY_DATABASE_URI = 'sqlite:///base.db'
SQLALCHEMY_TRACK_MODIFICATIONS = False

# Определение моделей дб
# ...

# Создание репозитория миграции
flask db init
```

## Миграция
---
1. Вручную
2. Автоматическая


### Автоматическая
---
1. Alembic сравнивает схему базы данных, определенную моделями данных, с фактической схемой базы данных, используемой в данный момент в базе данных.

2. Скрипт миграции заполняется изменениями, необходимыми для приведения схемы базы данных в соостветсвие с моделями приложений.

```bash
# Генерирует сценарий для автоматической миграцию
flask db migrate -m "Комментарий к миграции"

# Применяет изменения к бд согласно сценарию миграции
flask db upgrade
```

#### Если база не существует
---
| DB          | Action                                 |
|-------------|----------------------------------------|
| SQLite      | БД автоматически создасться            |
| MySQL       | Необходимо генерировать самостоятельно |
| PostrgreSQL | Необходимо генерировать самостоятельно |

### Откат изменений
---
```bash
# Применить миграцию в обратном порядке
flask db downgrade base
```
- Команде downgrade не задан целевой параметр, поэтому она понижает на одну ревизию
- Значение base вызывает понижение миграции до тех пор, пока база данных не останется в исходном состоянии, без таблиц

```bash
# Повторно применяет все миграции в прямом порядкею
flask upgrade
```
Для **upgrade** значением по умолчанию является `head`, которая является кратчайшим путем до самой последней миграции. Эта команда эффективно восстанавливает таблицы, которые были понижены выше.

```bash
# По сути очистка всех таблиц
flask db downgrade base
flask upgrade
```
Поскольку при миграции бд данные, хранящиесф в бд не сохраняются, понижение рейтига и последующие обновление приводит к быстрой очистке всех таблиц.


