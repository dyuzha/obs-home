---
id: servers
aliases:
  - Web-servers
tags: []
---
**Back**
    [[!!Base]]

# Web-servers
---
Отличия Apache от Nginx

Главное отличие серверов - обработка соединений и реакция на различные виды трафика

# Apache HTTP Server
---
Предлагает гибкие возможности для выбора различных алгоритмов
- Гибкость
- Мощность
- Распрастраненность
- МБ расширен за счет системы динамически загружаемых модулей

## Архитектура обработки соединений
---
Предоставляет несколько модулей **мультипроцессинга** (MPM), которые отвечаю за обработку пользовательских запросов. Это помогает администраторам Apache определять политику обработки соединений

**MPM** (Multi-Processing Modules)

### mpm_prefork
- Создает по одному процессу с одним потоком на каждый запрос
- Каждый процесс может обрабатывать только одно соединение в один момент времени
(Пока число запросов меньше числа процессов этот MPM работает очень быстро)
- Падает производительность, когда число запросов превышает число процессов
- Т.к. каждый процесс потребляет большое количество RAM,
=> этот MPM  сложно поддается маштабированию

- (???) - Но он мб использован с компонентами, которые не созданы для работы в многопоточной среде. (н-р) PHP, не является потокобезопасным, поэтому этот MPM рекомендуется использовать как безопасный метод работы с mod_php

- Удерживает поток вне зависимости от того активное это соединение или keep-alive

### mpm_worker
- Создает процессы, каждый из которых может управлять несколькими потоками.
Каждый поток может обрабатвать одно соединение
- Потоки значительно более эффективнее, чем процессы, что означает, что
mpm_worker масштабируется значитеьлно лучше чем mpm_prefork
- Т.к. потоков больше чем процессов это означает, что новое соединение может быть сразу обработано свободным потоком, а не ждать пока освободиться процесс

### mpm_event
- Схож с mpm-worker, но при этом оптимизирован для работы с keep-alive соединениями

> [!NOTE] keep-alive
> Connection:Keep-Alive - это заголовок, который указывает серверу оставить
соединение открытым.
> т.е. сервер не будет закрывать соединение сразу после отправки ответа
> => следующий запрос от этого же клиента к серверу будет обработан быстрее

- Выделяет отдельные потоки для:
  - keep-alive соединений
  - активных соединений

=> Это позволяет модулю не погрязнуть в keep-alive соединениях, что необходимо
для быстрой работы (этот модуль был помечен как стаблильный в Apache 2.4)

## Статический и динамический контент
---
### Статический контент
Apache может раздавать статический контент используя стандартные file-based
методы (производительность таких операций зависит от выбранного MPM)


### Динамический контент
Apache также может раздавать динамический контент встраивая интерпретатор нужного языка в каждого воркера.

- => Позволяет обрабатывать запросы к динамическому содержимому средствами самого веб-сервера и не полагаться на внешние компоненты

- => Упрощает конфигурирование *(Нет необходимости настраивать взаимодействие с дополнительным софтом, динамический модуль может быть легко отключен в случае изменившихся требований)*

## Распределенная конфигурация против централизованной
---
- Имеет опцию, которая позволяет задавать конфигурацию на уровне директории
  - Если эта опция включена, то Apache будет искать конфигурационные директивы в директориях с конетентом
  - `.htaccess`

Т.к. `.htaccess` находятся в директориях с контентом, Apache вынужден при
обработке каждого запроса проверять не содержит ли каждый компонент
запрашиваемого пути файл `.htaccess` и исполнять директивы найденные в файлах.
- Это позволяет децентрализовать конфигурирование веб-сервера.
=> Реализовать на уровне директорий:
  - модификацию URL'ов
  - ограничение доступа
  - политику кеширования
  - авторизацию и аутентификацию
  *(Все это мб настроено в основном конфигурационном файле Apache)*

**Преимущества**
- Эти файлы интерпритируются как только они найдены по запрашиваемому пути
=> Что позволяет менять конфигурацию на лету, не перезагружая веб-сервер
- Позволяет дать возможность непривилегированным пользователям контролировать
определенные аспекты собственных веб-приложений с помощью .htaccess
  - Это дает простой способ таким приложениям как системы управления контентом
  (CMS) конфигурировать собственное окружение не имея доступа к
  конфигурационному файлу веб сервера
  - Также используется shared-хостингами, чтобы сохранить контроль над основным
  конфигурационном файле

## Интерпритация базирующаяся на файлах и URL
---
Веб сервер интерпретирует запрос и сопоставляет его с ресурсом

Apache имеет возможность интерпретировать запрос как
- физический ресурс в файловой системе
  *(Использует конфигурационные блоки `<Directory>` или `<File>`)*
- URL *(Использует блоки `<Location>`)*

- Так как Apache изначально был спроектирован как веб-сервер, он по умолчанию
интерпретирует запросы как ресурсы в файловой системе.

- Он берет document root веб-сервера и дополняет его частью запроса, которая
следует за именем хоста и номером порта, чтобы найти запрашиваемый файл

- В общем случае, иерархия файловой системы представленная в вебе доступна как
дерево документов

- Apache предоставляет ряд альтернатив на случай когда запрос не соответствует файлу в файловой системе
  - Использование блоков `<Location>` это метод работы с URL без отображения на файловую систему.
  - Можно использовать регулярные выражения, которые позволяют  задать гибкие настройки для всей файловой системы

- Так как Apache может оперировать и с файловой системой, и с webspace, то он в
основном опирается на методы работы с файловой системой.
*(Это видно в некоторых решениях в дизайне архитектуры веб-сервера, например, в
использованиии файлов .htaccess для конфигурирования на уровне директорий)*

- (???) Документация Apache не рекомендует использовать URL-блоки для ограничения доступа для запросов к файловой системе.


## Modules
И Apache и Nginx могут быть расширены с помощью модулей, но способы реализации модульной системы принципиально отличаются

Динамическая Загрузка, Выгрузка модулей
  - Ядро Apache всегда доступно
  - Модули можно off/on, чтобы добавить или удалить функциональность из
  основного серврера.

Существует большое множество модулей, которые могут изменять ключевые
особенности сервера, например модуль `mod_php` позволяет включать PHP
интерпретатор в каждого воркера

Возможности модулей:
- изменение URL'ов (URL rewrite),
- аутентификация клиентов
- защита сервера
- сжатие
- проксирование
- ограничение частоты запросов
- шифрование


# Nginx
---
Появился намного позже Apache
Спроектирован на базе асинхронных неблокирующих event-driven алгоритмов

- Эффективное потребление ресурсов
- Отзывчивая работа под нагрузкой
- Можно использовать как HTTP Server и как proxy

## Архитектура обработки соединений
---
- Создает процессы-воркеры, каждый из которых может обслуживать тысячи соединений
Воркеры работают на быстром цикле, в котором проверяются и обрабатываются события

- Отделение основной работы от обработки соединений позволяет каждому воркеру заниматься своей работой, а отвлекаться на обработку соединений, только когда произошло новое событие

- Каждое соединение, обрабатываемое воркером, помещается в event loop вместе с другими соединениями
  - В этом цикле события обрабатываются асинхронно, позволяя обрабатывать задачи в неблокирующей манере
  - Когда соединение закрывается - оно удаляется из цикла
  => Этот подход позволяет Nginx невероятно масштабироваться при ограниченных ресурсах. Поскольку сервер однопоточный и он не создает процессы под каждое соединение, использование памяти и CPU относительно равномерно, даже при высоких нагрузках

## Статический и динамический контент
---
### Статический контент
Статический контент будет возвращен клиенту простым способом

### Динамический контент
Nginx не имеет возможности самостоятельно обрабатывать запросы к динамическому
контенту
Для обработки запросов к PHP или другому динамическому контенту Nginx должен
- передать запрос внешнему процессору для исполнения,
- подождать сгенерированного ответа
- получить ответ
После обработки результат мб отправлен клиенту
=> нужно настроить взаимодействие Nginx с таким процессором используя один из
протоколов:
- http
- FastCGI
- SCGI
- uWSGI
- memcache

В результате используется дополнительное соединение с процессором на каждый
пользовательский запрос
*(Это может немного усложнить процесс настройки, в особенности когда вы будете
пытаться какое число соединений разрешить)*

**Преимущества**
Т.к. интерпритатор не встроен в каждого воркера, то оверхед, связанный с этим,
будет иметь место только при запросах к динамическому контенту.
- Запросы к интерпритатору выполняются только когда они нужны.
*(Apache тоже может работать в такой манере, при лишения остальных преимуществ)*

## Распределенная конфигурация против централизованной

Nginx
- не интерпретирует файлы .htaccess
- Не предоставляет механизм конфигурирования на уровне директорий за пределами
основного конфигурационного файла.

**Преимущество**
- Улучшенная производительность (Сервер не вынужден проверять каждый раз
`.htaccess` файл)
Nginx достаточно сделать один directory lookup м прочитать один конфигурационный
файл

- Безопасность
Распределенная конфигурация на уровне директорий Apache возлагает
ответственность за безопасность на обычных пользователей, которые вряд ли
способны решить эту задачу качественно.
*(Контроль сервера со стороны администрации предотвращает ошибки безопасности,
которые могут возникнуть если дать пользователям доступ к конфигурации)*

## Интерпритация базирующаяся на файлах и URL
Веб сервер интерпретирует запрос и сопоставляет его с ресурсом

Nginx создан, чтобы работать в качестве:
- веб-сервера
- прокси-сервера
*(По этой причине он работает в первую очередь с URL, транслируя их при
необходимости в запросы к файловой системе)*

Эта особенность прослеживается в том как для Nginx конструируются и
интерпретируются конфигурацонные файлы.
В Nginx нет способа создать конфигурацию для заданной директории, вместо этого
он парсит URL.
Основными конфигурационными блоками в Nginx являются
- `<Server>`
  В блоке `<Server>` определяется host, который будет обслуживаться
- `<Location>`
  Блок `<Location>` отвечает за обработку части URL, которая идет после имени
  хоста и номера порта.
  Таким образом, запрос интерпретируется как URL, а не как путь в файловой
системе

В случае запросов к статическим файлам все запросы должны быть отображены
(mapped) на путь в файловой системе.

Сначала Nginx выбирает блоки `<Server>` и `<Location>`, которые будут
использованы для обработки запроса и затем объединяет `document root` с URL, в
соответствии с конфигурацией.

Эти подходы (интерпретация запроса как пути в файловой системе и как URL) могут
показаться похожими, но тот факт что Nginx рассматривает запросы как URL, а не
как пути в файловой системе позволяет ему легче справляться одновременно и с
ролью веб-сервера и с ролью proxy.

Nginx конфигурируется так, чтобы отвечать на различные шаблоны запросов.
Nginx не обращается к файловой системе до тех пор пока он не готов обслужить запрос, чтот объяснет почему он не реализует ничего похожего на файлы .htaccess
## Modules

В Nginx модули компилируются вместе с ядром сервера

Обычно разработчики дистрибутивов стремятся сохдать пакеты для всех часто
используемых модулей. Но если нужен какой-то нестандартный модуль, его придется
собрать из исходников.

- Это считается более безопасно, так как произвольные модули не могут быть
подключены к серверу

Модули имеют тот же функционал, что и у Apache:
- Проскирование
- Сжатие данных
- Ограничение частоты запросов
- Логгирование
- Модификация URL'ов
- Геолокация
- Аутентификация
- Шифрование
- Потоковое вещание
- Почтовые функции


# Совместное решение Nginx + Apache
---
Рвспространенная схема использования является размещение Nginx перед Apache в качестве reverse-proxy.
- Nginx - Frontend
  - Обслуживает все входящие запросы клиентов, благодаря его возможности обрабатывать множество конкурентных запросов.
  - Обслуживает статический контент, динамический передавать Apache
- Apache - Backend
  - Получает от Nginx запрос, рендерит динамический контент и возвращает его Nginx

- Nginx используется для сортировки заппросов (Он обрабатывает запросы, которые может, остальные перенаправляет на Apache)

Данная конфигурация позволяет горизонтально масштабировать приложение:
- Можно установить несколько backend-серверов за одним фронтендом и Nginx будет распределять нагрузку между ними, увеличивая тем самым отказоустойчивость приложения.


source: [Habr - Apache bs Nginx](https://habr.com/ru/articles/267721/)
