---
id: Memory
aliases: []
tags: []
---
**Back**
    [[!Lin]]

# Память в Linux
---

## Управление памятью для процессов
---
Любой запущенный процесс получает собственный выделенный участок памяти.
НО этому процессу не доступны физические адреса

-> Процесс использует *Виртуальное адресное пространство*, являющимся дополнительным слоем абстракции между процессом и физической памятью.

Для сопоставления адресов между виртуальной и физической памятью, используется специальные структуры - *таблицы страниц*

### Преимущества
---
1. Изоляция процессов друг от друга
  *Каждый из них работает в собственном виртуальном пространстве и не имеет доступа к памяти других процессов.*

2. Гибкое управление памятью для системы
  *Например, для неактивного процесса часть страниц мб перенесено из оператиыной памяти в пространство подкачки, но этот никак не повлияет на работу самого процесса*
    - Адресное пространство не измениться
    - Измениться лишь трансляция в таблице страниц

3. Позволяет экономить физическую память
  *Если несколько процессов используют одни и те же данные, то система может транслировать адреса виртуальных пространств на один и тотже участок физической памяти*

**Итого**:
  Размер виртуальной памяти в системе теоретически ничем не ограничен
  - ее общий объем может существенно превышать имеющуюся в наличии физическую память

**Например**:
  Запущенно несколько графических приложений Qt и GTK
  - Достаточно 1 раз загрузить библиотеку в память, а затем просто транслировать адреса виртуальной памяти процессов на одни и теже участки физической памяти

  - При этом каждый процесс будет думать, что у него загружена собственная копия библиотек

Поэтому современные Linux-системы выделяют память процессам с превышением имеющейся в наличии физической памяти (RAM + Swap)


### Настройка
---
vm.max_map_count - параметр ядра линукс, определяющий максимальное количество "memory maps" (отображений памяти), которые может созда процесс
*Каждая программа в Linux может запросить у ядра "отображение" файла или памяти в свое адресное пространство, это называется mmap (memory-mapped file)*

```bash
# Проверить тек. значение
sysctl vm.max_map_count

# Изменить (временно, до reboot'a)
sudo sysctl -w vm.max_map_count=262144

# На постоянку
echo "vm.max_map_count=262144" | sudo tee -a /etc/sysctl.conf

# Применить изменения
sudo sysctl -p

# Проверка для конкретного процесса
cat /proc/<PID>/maps | wc -l

```
