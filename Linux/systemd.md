# Base
---
**Systemd** состоит из 3-ех элементов:
- **systemd** - менеджер системы и сервисов
- **systemctl** - утилита для просмотра и управления статусом сервисов
- **systemd-analyze** - предоставляет статистику пр процессу загрузки системы, проверяет корректность *unit*-файлов и так же имеет возможности отладки **systemd**

- **Systemd** спроектирован так, чтобы централизованно управлять системными логами от процессов, приложений и т.д. (эти события обрабатываются демоном **Journald**)

- Посмотреть названия сервисов
    `systemctl list-units --type=service`

# Переменные окружения
---
`SYSTEMD_LESS` -  переменная обознаяющая как `less` работать
`SYSTEMD_LESS=FRSZMK` - по умолчанию
    - `S` - обрезать то что не вмещается в экран 
        - *если убрать, то строки будут переноситься*
            `SYSTEMD_LESS=FRSZMK journalctl`


# Journald
---
**Journald** - системный демон журналов *systemd*
- Он собирает логи со всей системы и сохраняет их в *bin*-файлах
    - Их можно транслировать как в *текст*, так и в *Json*

- Path:
    `/etc/systemd/journald.conf` - config
    `/run/log/journal` - каталог с журналом

# Setting (Config)
---
- По умолчанию **journalctl** перезаписывает свои журналы логов при каждой перезагрузке

- Если в `journald.conf` параметр `Storage=auto`
    и `/var/log/journal/` не существуют, журнал будет записываться в `/var/log/jornal` без сохранения между перезагрузками

- Если `/var/log/journal/` существует, журналы будут сохраняться в нем на постоянной основе *(но если будет удале, то Systemd его пересоздаст автоматически и вместо этого будет вести журнал снова в `/run/systemd/journal` без сохранения)*
    - Исправить это можно, добавив `Storage=persistent` в конфиг и перезапустить `systemd-journald.servise` *(или перезагрузиться)*
```bash
mkdir /var/log/journal
systemd-tmpfiles --create --prefix /var/log/journal
systemctl restart systemd-journald
```

`SystemMaxUse`- макисимальный объем журнала
    `SystemMaxUse=50M`
    - **По умолчанию размер журнада ограничен 10% от объема файлового раздела и максимально может занять 4гб диского пространства**

# Commands
---
**journalctl** - команда для просмотров логов
    - Выведет все записи из всех журналов, начиная с того момента как система начала загружаться 

- По умолч. выводит в формате системного времени
    `--utc` - просмотр логов в формате **UTC**

- Уровни важности
    `-p <lvl>`
    
    Уровни важности:
        - `0:`emergency - неработоспособность системы 
        - `1:`alert - предупреждения, требующие немедленного вмешательства
        - `2:`critical - критическое состояние
        - `3`:errors 
        - `4`:warning
        - `5`:notice (уведомления)
        - `6`:info (информационные сообщения)
        - `7`:debug

- Если **Journald** натсроен на постоянное хранение журналов
    `journalctl --list-boots` - просмотреть список журналов

```bash
# просмотреть список журналов
`journalctl --list-boots` 
>>> <numb> <buutID> <start date> <end date>
 ```
`<numb>` - номер журнула *(который можно использовать для просмотра определенной сесси)*
`<bootID>` - *(так же можно использовать для просмотра отдельного журнала)*
>[!Example]
```bash
-1 0aa7f5...bc473 Mon 2024-08-05 03:00:00 MSK Sat 2024-09-14 13:45:50 MSK
 0 6417b6b...2b83 Mon 2024-08-05 03:00:00 MSK Wed 2024-09-18 21:17:58 MSK
```

```bash
# просмотреть список журналов
journalctl --list-boots 

# просмотр журнала конкретной сессии
journalctl --list-boots	-b <numb-session> 
	-b 0 # текущая
	-b -1 # предыдущая
	
# Указать конкретный файл
journalctl --file </var/log/journal/ewefq...f3f> 

# Просмотр журнала с ... [по ...]
journalctl --since "<date [time]>" [--until "<date [time]>"] 

# Например
journalctl --since "2020-12-17" --until "2020-12-18 10:00:00"

# вчерашнего дня
journalctl --since yesterday 

# c 9:00 по час назад
journalctl --since 09:00 --until "1 hour ago" 

 -k - просмотр сообщений ядра
 -f - следить за появлением новых сообщений *(аналог tail -f)*
 -e - открыть журнал, "перемотав" его к последней записи
    --file </var/log/journal/ewefq...f3f -f> - указать конкретный файл *(чтобы долго не думал)*
 ```

## Удаление архивных журналов
```bash
# Удалить с помощью системного вызова
rm <журнал> 

# удалить журналы оставив последний 100мб
rm --vacuum-size=100M 

# удалить журналы оставив только за последние 7д
rm --vacuum-time=7d 
```

## Просмотр определенного сервиса/приложения
```bash 
# Просмотреть определенный сервис/приложение
journalctl -u <service-name/app-name> # указав имя
journalctl <исполняемый файл> # указав его исполняемый файл
journalctl _PID=<num-pid> # указав его PID
```
